<link rel="import" href="imports.html">

<dom-module id="lrnapp-book">
  <template>
    <style include="materializecss-styles"></style>
    <style>
      :host {
        display: block;
      }
      app-toolbar {
        color: gray;
        border-bottom: 2px solid whitesmoke;
        background-color: white;
      }
      paper-button {
        padding: 0;
        margin: 0;
        min-width: 1rem;
      }

      app-drawer {
        padding: 0;
        top: 0;
        bottom: 0;
        z-index: 100;
        --app-drawer-content-container: {
          background-color: #fafafa;
          padding: 10px;
          z-index: 100;
          border-right: 1px solid #c8c8c8;
          overflow: inherit;
        }
      }

      lrndesign-stepper-button {
        --lrndesign-stepper-btn-active: #f6f7f7;
      }
      .title {
        margin-left: 10px;
        max-width: 50%;
      }

      #content-wrap {
          min-height: 500px;
          display: flex;
          flex-wrap: wrap;
          justify-content: space-around;
      }

      .content-body {
        position: relative;
        padding: 2em;
        font-family: sans-serif;
        font-size: 1.3em;
        width: 80%;
        margin: 0 auto;
      }

      .lrns-prev-next-button {
        display: flex;
        flex: 0 1 50%;
        justify-content: center;
        align-items: center;
      }
      @media screen and (min-width: 600px) {
        #content-wrap .prev {
          order: 0;
        }
        #content-wrap .content-body {
          order: 1;
          flex: 1 1 auto;
        }
        #content-wrap .next {
          order: 2;
        }
        #content-wrap {
          flex-direction: row;
          flex-wrap: nowrap;
        }
      }
      .content-body {
        flex: 0 1 100%;
      }

      app-header {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        color: black;
        background-color: white;
        z-index: 1;
        padding: 1em 0 0 0;
      }

      [main-title] {
        font-weight: lighter;
        height: 100%;
        padding: 2em .5em 0 .5em;
      }

      @media (max-width: 639px) {
        [main-title] {
          margin-left: 50px;
          font-size: 30px;
        }
        [condensed-title] {
          font-size: 15px;
        }
      }
    </style>
    <iron-ajax
       auto
       id="ajax"
       params="[[requestParams]]"
       url="[[sourcePath]]"
       handle-as="json"
       on-response="handleResponse"
       last-response="{{requestData}}"></iron-ajax>

    <app-drawer id="drawer" opened="[[opened]]" swipe-open transition-duration="500">
      <div style="height: 100%; overflow: auto;">
        <paper-search-bar hide-filter-button></paper-search-bar>
        <div class="course-title-drawer">Course Outline</div>
        <div class="stepper-button-wrapper">
          <div class="tab-wrapper">
            <div class="tabs">
              <template is="dom-repeat" items="[[items]]" as="item">
                <lrndesign-stepper-button class="tab" title="[[item.title]]" icon="[[item.icon]]" location="[[item.url]]"></lrndesign-stepper-button>
              </template>
            </div>
          </div>
        </div>
      </div>
    </app-drawer>

    <app-header condenses reveals shadow effects="parallax-background">
      <app-toolbar class="tall">
        <div style="pointer-events: auto;" class="menu-btn-wrap">
          <paper-icon-button style="pointer-events: auto;" title="Content outline" id="menubutton" icon="menu"></paper-icon-button>
        </div>
        <div spacer class="title">[[title]]</div>
        <div spacer main-title style="pointer-events: auto;">
          <lrnsys-progress title="The steps to complete this lesson" id="progress" active="0" items="{{items}}" progressive-unlock></lrnsys-progress>
        </div>
      </app-toolbar>
    </app-header>

    <div id="body">
      <div class="content-body">
        <p>
          <slot></slot>
        </p>
      </div>
      <div class="lrns-prev-next-button prev">
          <paper-icon-button title="previous button" on-tap="prevBtn" icon="hardware:keyboard-arrow-left"></paper-icon-button>
      </div>
      <div class="lrns-prev-next-button next">
          <paper-icon-button title="next button" on-tap="nextBtn" icon="hardware:keyboard-arrow-right"></paper-icon-button>
      </div>
    </div>
  </template>
  <script>
    Polymer({
      is: 'lrnapp-book',
      listeners: {
        'menubutton.tap': 'toggleoutline',
        'progress.progress-response-loaded': 'loadPage',
      },
      properties: {
        requestParams: {
          type: Object,
          reflectToAttribute: true,
          notify: true,
          value: {
            "node": null
          },
        },
        items: {
          type: Array,
          value: [],
        },
        requestData: {
          type: Object,
          reflectToAttribute: true,
          notify: true,
        },
        hasPrevPage: {
          type: Boolean,
          reflectToAttribute: true,
          notify: true,
        },
        prevPage: {
          type: String,
          reflectToAttribute: true,
          notify: true,
        },
        hasNextPage: {
          type: Boolean,
          reflectToAttribute: true,
          notify: true,
        },
        nextPage: {
          type: String,
          reflectToAttribute: true,
          notify: true,
        },
      },
      /**
       * Load the page that the progress bar dictated.
       */
      loadPage: function (e) {
        console.log(e.detail);
      },
      /**
       * Toggle the outline.
       */
      toggleoutline: function (e) {
        this.$.drawer.toggle();
      },
      /**
       * Handle the response.
       */
      handleResponse: function (obj) {
        let root = this;
        const response = obj.detail.response.data.items;
        this.set('items', response);
        // look for previous link
        if (typeof response.prev !== typeof undefined) {
          root.hasPrevPage = true;
          root.prevPage = response.prev;
        }
        else {
          root.hasPrevPage = false;
        }
        // look for next link
        if (typeof response.next !== typeof undefined) {
          root.hasNextPage = true;
          root.nextPage = response.next;
        }
        else {
          root.hasNextPage = false;
        }
        // ensure we have content
        if (typeof response.content !==  typeof undefined) {
          root.$$('#nav').innerHTML = response.content.nav;
          root.$$('#breadcrumb').innerHTML = response.content.breadcrumb;
          root.$$('#content').innerHTML = response.content.body;
        }
      },
      loadNextPage: function() {
        let root = this;
        root.$$('#ajax').params.node = root.nextPage;
        root.$$('#ajax').generateRequest();
      },
      loadPrevPage: function() {
        let root = this;
        root.$$('#ajax').params.node = root.prevPage;
        root.$$('#ajax').generateRequest();
      },
      changePage: function(e) {
        let root = this;
        console.log(e);
        //root.$$('#ajax').params.node = root.activePage;
        root.$$('#ajax').generateRequest();
      },
      /**
       * Simple way to convert from object to array.
       */
      _toArray: function(obj) {
        return Object.keys(obj).map(function(key) {
          return obj[key];
        });
      },
    });
  </script>
</dom-module>
